# 基本設計

## ユースケース

### 加入者情報管理機能

#### 加入者を登録する

- **主アクター** 管理者
- **事前条件** なし

    1.	管理者は、加入者登録画面を表示する
    2.	サービス管理システムは、加入者登録画面を表示する
    3.	管理者は加入者情報を登録する。
    4.	サービス管理システムは、加入者情報を保存する
    5.	管理者は、加入者情報を確認する
- **拡張シナリオ**
    4a. サービス管理システムは入力エラーを表示する
- **成功時保証** 加入者情報がデータベースに登録される

#### 加入者を編集する

- **主アクター** 管理者
- **事前条件** 加入者情報が登録済みであること
- **主シナリオ**
    1.	管理者は、加入者情報を検索する
    2.	サービス管理システムは、加入者情報の一覧を名前基準に昇順で表示する。
    3.	管理者は、一覧から対象の加入者を選択する。
    4.	サービス管理システムは加入者情報を表示する。
    5.	管理者は、加入者情報を修正する。
    6.	サービス管理システムは、加入者情報を保存する。
    7.	管理者は、加入者情報を確認する
- **拡張シナリオ**
    - サービス管理システムは入力エラーを表示する
- **成功時保証** 加入者情報が更新される

#### 加入者を削除する

- **主アクター** 管理者
- **事前条件** 加入者情報が登録済みであること
- **主シナリオ**
    1.	管理者は、加入者情報を検索する
    2.	サービス管理システムは、加入者情報の一覧を名前基準に昇順で表示する。
    3.	管理者は、一覧から対象の加入者を選択する。
    4.	サービス管理システムは加入者情報を表示する。
    5.	管理者は、加入者情報を削除する。
    6.	サービス管理システムは、加入者情報を保存する。
    7.	管理者は、加入者情報を確認する
- **拡張シナリオ**
	- サービス管理システムは入力エラーを表示する
- **成功時保証** 加入者情報が削除される

### 料金管理機能

#### 料金情報の登録する
- **主アクター** 管理者
- **事前条件** 登録対象が登録されていないこと
- **主シナリオ**
    1.	管理者は、基本料金登録画面を表示する
    2.	サービス管理システムは、基本料金登録画面を表示する
    3.	管理者は料金情報を登録する。
    4.	サービス管理システムは、料金情報を保存する
    5.	管理者は、料金情報を確認する
- **拡張シナリオ**
    - サービス管理システムは入力エラーを表示する
- **成功時保証** 料金情報がデータベースに登録される

#### 料金情報を編集する

- **主アクター** 管理者
- **事前条件** 料金情報が登録済みであること
- **主シナリオ**
    1.	管理者は、料金情報を検索する
    2.	サービス管理システムは、料金情報の一覧を名前基準に昇順で表示する。
    3.	管理者は、一覧から対象の基本料金を選択する。
    4.	サービス管理システムは料金情報を表示する。
    5.	管理者は、料金情報を修正する。
    6.	サービス管理システムは、料金情報を保存する。
    7.	管理者は、料金情報を確認する
- **拡張シナリオ**
	- サービス管理システムは入力エラーを表示する
- **成功時保証** 料金情報が更新される

#### 料金情報を削除する

- **主アクター** 管理者
- **事前条件** 料金情報が登録済みであること
- **主シナリオ**
    1.	管理者は、料金情報を検索する
    2.	サービス管理システムは、料金情報の一覧を名前基準に昇順で表示する。
    3.	管理者は、一覧から対象の基本料金を選択する。
    4.	サービス管理システムは料金情報を表示する。
    5.	管理者は、料金情報を削除する。
    6.	サービス管理システムは、料金情報を保存する。
- **拡張シナリオ**
    - サービス管理システムは入力エラーを表示する
- **成功時保証** 加入者情報が削除される

### 請求データ作成機能

#### 請求データを作成する

- **主アクター** サービス管理システム
- **事前条件** このユースケースは毎月1日に1回実行されること
- **主シナリオ**
    1.	サービス管理システムは、加入者ごと基本料金と追加オプション料金を集計し、請求データを作成する。
    2.	請求データおよび請求明細データテーブルにトランザクションとしてレコード追加する。
    3.	サービス管理システムはトランザクションを確定する。
- **拡張シナリオ**
	- 処理中にエラーが発生した場合は中断し、トランザクションをロールバックする。
- **成功時保証** 当月分の請求データおよび請求明細データが作成される


## 概念モデル

``` mermaid
classDiagram
direction LR
    加入者 "1" -- "*"  請求データ
    料金 "1" -- "*" 請求明細データ
    請求状況 "1" -- "0,1" 請求データ
    請求データ *--> "*" 請求明細データ

```

## データベース物理設計

``` mermaid
erDiagram
    User {
        BIGINT          member_id       PK
        VARCHAR(255)    mail
        VARCHAR(32)     bane
        VARCHAR(123)    address
        DATE            start_date
        DATE            end_date
        TINYINT         payment_method
        TIMESTAMP       created_at
        TIMESTAMP       modified_at
        
    }

    Charge {
        BIGINT          charge_id       PK
        VARCHAR         name
        NUMERIC(9)      amount      
        DATE            start_date
        DATE            end_date
        TIMESTAMP       created_at
        TIMESTAMP       modified_at
    }

    BillingStatus {
        DATE            billing_ym         PK
        BOOLEAN         is_commited
        TIMESTAMP       created_at
        TIMESTAMP       modufied_at
    }

    Billing {
        DATE            billing_ym  PK
        BIGINT          member_id   PK
        VARCHAR(255)    mail
        VARCHAR(32)     bane
        VARCHAR(123)    address
        DATE            start_date
        DATE            end_date
        TINYINT         payment_method
        NUMERIC(10)     amount      
        NUMERIC(5_2)    tax_ratio
        NUMERIC(10)     total
        TIMESTAMP       created_at
        TIMESTAMP       modified_at
    }

    BillingDetail {
        DATE            billing_ym  PK
        BIGINT         member_id   PK
        BIGINT         charge_id   PK
        VARCHAR         name
        NUMERIC(9)       amount      
        DATE            start_date
        DATE            end_date
    }

    User ||..o{ Billing : ""
    Charge ||..o{ BillingDetail : ""
    BillingStatus ||--o| Billing : ""
    Billing ||--|{ BillingDetail : ""
```